receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

  # Federate ALL metrics from Prometheus server
  # Prometheus scrapes Traefik, Flask, and Node Exporter
  # EDOT fetches all metrics from Prometheus via /federate endpoint
  prometheus:
    config:
      scrape_configs:
        - job_name: 'prometheus-federation'
          scrape_interval: 15s
          honor_labels: true  # Preserve original job labels from Prometheus
          metrics_path: '/federate'
          params:
            'match[]':
              - '{job="traefik"}'       # Get all Traefik metrics
              - '{job="flask-app"}'     # Get all Flask metrics
              - '{job="node-exporter"}' # Get all Node Exporter metrics
          static_configs:
            - targets: ['prometheus:9090']

processors:
  batch:
    timeout: 10s
    send_batch_size: 1000

  # Filter for Traefik metrics (from federated Prometheus)
  filter/traefik:
    metrics:
      include:
        match_type: strict
        metric_names:
          - traefik_*  # All Traefik metrics start with traefik_

  # Filter for Flask metrics (from federated Prometheus)
  filter/flask:
    metrics:
      include:
        match_type: regexp
        metric_names:
          - flask_.*
          - python_.*
          - process_.*
          - http_.*

  # Filter for Node Exporter metrics (from federated Prometheus)
  filter/node:
    metrics:
      include:
        match_type: strict
        metric_names:
          - node_*  # All Node Exporter metrics start with node_

  # Traefik metrics → metrics-traefik.otel-default
  resource/traefik:
    attributes:
      - key: deployment.environment
        value: demo
        action: upsert
      - key: data_stream.type
        value: metrics
        action: upsert
      - key: data_stream.dataset
        value: traefik
        action: upsert
      - key: data_stream.namespace
        value: default
        action: upsert

  # Flask metrics → metrics-flask.otel-default
  resource/flask:
    attributes:
      - key: deployment.environment
        value: demo
        action: upsert
      - key: data_stream.type
        value: metrics
        action: upsert
      - key: data_stream.dataset
        value: flask
        action: upsert
      - key: data_stream.namespace
        value: default
        action: upsert

  # Node Exporter metrics → metrics-node.otel-default
  resource/node:
    attributes:
      - key: deployment.environment
        value: demo
        action: upsert
      - key: data_stream.type
        value: metrics
        action: upsert
      - key: data_stream.dataset
        value: node
        action: upsert
      - key: data_stream.namespace
        value: default
        action: upsert

  # Flask traces → traces-flask.otel-default
  resource/traces:
    attributes:
      - key: deployment.environment
        value: demo
        action: upsert
      - key: data_stream.type
        value: traces
        action: upsert
      - key: data_stream.dataset
        value: apm
        action: upsert
      - key: data_stream.namespace
        value: default
        action: upsert

  # Flask logs → logs-flask.otel-default
  resource/logs:
    attributes:
      - key: deployment.environment
        value: demo
        action: upsert
      - key: data_stream.type
        value: logs
        action: upsert
      - key: data_stream.dataset
        value: apm
        action: upsert
      - key: data_stream.namespace
        value: default
        action: upsert

  resourcedetection:
    detectors: [system, docker]
    timeout: 5s

connectors:
  elasticapm:

exporters:
  # Native Elasticsearch OTLP endpoint
  otlphttp/elastic:
    endpoint: https://f8eb737865d740c9b480ea81047abd59.us-east-1.aws.found.io/_otlp
    headers:
      Authorization: ApiKey VmJVZVZwb0J2THhzam9MTEs0eGk6aUdvOXVqRUp6VEZ5blFkU20yZTN4dw==
    compression: gzip

  # Elasticsearch exporter for traces/logs
  elasticsearch:
    endpoints:
      - https://f8eb737865d740c9b480ea81047abd59.us-east-1.aws.found.io:443
    api_key: VmJVZVZwb0J2THhzam9MTEs0eGk6aUdvOXVqRUp6VEZ5blFkU20yZTN4dw==
    compression: gzip
    mapping:
      mode: otel

  debug:
    verbosity: basic
    sampling_initial: 2
    sampling_thereafter: 100

extensions:
  health_check:
    endpoint: 0.0.0.0:13133

service:
  extensions: [health_check]
  
  pipelines:
    # Traefik metrics from Prometheus Federation → metrics-traefik.otel-default (TSDB)
    metrics/traefik:
      receivers: [prometheus]
      processors: [filter/traefik, resourcedetection, resource/traefik, batch]
      exporters: [elasticsearch, debug]

    # Flask metrics from Prometheus Federation → metrics-flask.otel-default (TSDB)
    metrics/flask:
      receivers: [prometheus]
      processors: [filter/flask, resourcedetection, resource/flask, batch]
      exporters: [elasticsearch, debug]

    # Node Exporter metrics from Prometheus Federation → metrics-node.otel-default (TSDB)
    metrics/node:
      receivers: [prometheus]
      processors: [filter/node, resourcedetection, resource/node, batch]
      exporters: [elasticsearch, debug]

    # APM aggregated metrics → metrics-flask.otel-default
    metrics/aggregated:
      receivers: [elasticapm]
      processors: [resourcedetection, resource/flask, batch]
      exporters: [elasticsearch, debug]

    # Traces → traces-flask.otel-default
    traces:
      receivers: [otlp]
      processors: [resourcedetection, resource/traces, batch]
      exporters: [elasticsearch, elasticapm, debug]

    # Logs → logs-flask.otel-default
    logs:
      receivers: [otlp]
      processors: [resourcedetection, resource/logs, batch]
      exporters: [elasticsearch, debug]
